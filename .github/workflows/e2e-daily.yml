name: Daily E2E Test Report

on:
  schedule:
    - cron: "0 7 * * *"  # Daily at 2 AM ET (7 AM UTC)
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose python3 python3-pip libxml2-utils

    # Create .env BEFORE any docker-compose command
    - name: Create .env file for Docker Compose
      run: |
        cat << EOF > .env
        MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_INITDB_ROOT_USERNAME }}
        MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}
        RABBITMQ_DEFAULT_USER=${{ secrets.RABBITMQ_DEFAULT_USER }}
        RABBITMQ_DEFAULT_PASS=${{ secrets.RABBITMQ_DEFAULT_PASS }}
        EOF

    - name: Stop and remove all containers and volumes
      run: |
        docker-compose down -v --remove-orphans
        docker container prune -f
        docker volume prune -f
        docker network prune -f

    - name: Prune old Docker images (ensure fresh pulls)
      run: docker image prune -a -f || true

    - name: Pull Docker images
      run: docker-compose pull
      env:
        MONGO_INITDB_ROOT_USERNAME: ${{ secrets.MONGO_INITDB_ROOT_USERNAME }}
        MONGO_INITDB_ROOT_PASSWORD: ${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}
        RABBITMQ_DEFAULT_USER: ${{ secrets.RABBITMQ_DEFAULT_USER }}
        RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_DEFAULT_PASS }}

    - name: Debug docker-compose config
      run: docker-compose config

    - name: Start Docker Compose stack
      run: docker-compose up -d --remove-orphans
      env:
        MONGO_INITDB_ROOT_USERNAME: ${{ secrets.MONGO_INITDB_ROOT_USERNAME }}
        MONGO_INITDB_ROOT_PASSWORD: ${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}
        RABBITMQ_DEFAULT_USER: ${{ secrets.RABBITMQ_DEFAULT_USER }}
        RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_DEFAULT_PASS }}

    - name: Wait for mongo and mq1 to become healthy
      run: |
        echo "Waiting for containers with healthchecks to become healthy..."
        for i in {1..60}; do
          unhealthy=$(docker inspect --format '{{.Name}} {{.State.Health.Status}}' $(docker ps -q --filter "name=sdx-e2e-automation_mongo_1" --filter "name=sdx-e2e-automation_mq1_1") | grep -v healthy || true)
          if [ -z "$unhealthy" ]; then
            echo "Mongo and mq1 are healthy."
            break
          fi
          echo "Still waiting on: $unhealthy"
          sleep 5
        done
        echo "Docker containers (docker ps -a):"
        docker ps -a

    - name: Wait for pytest to be available in mininet
      run: |
        echo "Waiting for pytest to be installed in mininet..."
        for i in {1..30}; do
          if docker-compose exec -T mininet python3 -c "import pytest" 2>/dev/null; then
            echo "pytest is available in mininet."
            exit 0
          fi
          echo "pytest not available yet... ($i/30)"
          sleep 10
        done
        echo "pytest was not installed in time. Dumping mininet logs:"
        docker-compose logs mininet || true
        exit 1

    - name: Install Python requests in mininet
      run: docker-compose exec -T mininet python3 -m pip install requests

    - name: Run end-to-end tests in container
      run: docker-compose exec -T mininet python3 -m pytest tests/ --junitxml=/tmp/results.xml || true

    # /tmp is mounted as ./e2e-output, so watch the host path directly
    - name: Wait for results.xml file
      run: |
        echo "Waiting for ./e2e-output/results.xml on host..."
        for i in {1..24}; do
          if [ -f ./e2e-output/results.xml ]; then
            echo "Found results.xml on host."
            exit 0
          fi
          echo "Waiting for results.xml... ($i/24)"
          sleep 5
        done
        echo "results.xml not found after timeout."
        exit 1

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: results
        path: ./e2e-output/results.xml

    - name: Install Python dependencies for project update
      run: |
        if [ -f requirements.txt ]; then
          pip3 install -r requirements.txt
        else
          pip3 install requests
        fi

    - name: Update GitHub Project board
      env:
        GITHUB_ORG: atlanticwave-sdx
        GITHUB_PROJECT_NUMBER: 16
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN_PAT }}
      run: python3 update_project_from_results.py

    - name: Post Slack Summary (only if failed)
      if: always()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        SHORT_SHA=${GITHUB_SHA:0:7}

        if [ ! -f ./e2e-output/results.xml ]; then
          echo "results.xml not found; skipping Slack notification."
          exit 0
        fi

        PASSED=$(xmllint --xpath "count(//testsuite/testcase[not(failure) and not(skipped)])" ./e2e-output/results.xml)
        FAILED=$(xmllint --xpath "count(//testsuite/testcase[failure])" ./e2e-output/results.xml)
        SKIPPED=$(xmllint --xpath "count(//testsuite/testcase[skipped])" ./e2e-output/results.xml)
        TOTAL=$(xmllint --xpath "count(//testsuite/testcase)" ./e2e-output/results.xml)

        if [ "$FAILED" -gt 0 ]; then
          TEXT="X *E2E Test Failures Detected* (run #${GITHUB_RUN_NUMBER}, commit ${SHORT_SHA})\n*Passed:* $PASSED\n*Failed:* $FAILED\n*Skipped:* $SKIPPED\n*Total:* $TOTAL"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$TEXT\"}" "$SLACK_WEBHOOK_URL"
        else
          echo "No failures. Slack alert not sent."
        fi

